<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><link id=theme-style rel=stylesheet href=https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css><title>Micropython Mqtt Streamer | mozanunal.com</title><link rel=icon href=/favicon.svg type=image/svg+xml><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon href=/apple-touch-icon.png></head><body><header><div class=theme-selector><select id=theme-selector-input><option value=https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css>Pico</option><option value=https://cdn.jsdelivr.net/gh/digitallytailored/classless@latest/classless.min.css>Classless.css</option><option value=https://cdn.jsdelivr.net/gh/cspablocortez/cosmocss@latest/cosmo.min.css>Cosmo.css</option><option value=https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.min.css>Pico-Fluid</option><option value=https://cdn.jsdelivr.net/npm/water.css@2/out/water.css>Water.css</option><option value=https://cdn.jsdelivr.net/npm/sakura.css/css/sakura.css>Sakura.css</option><option value=https://cdn.simplecss.org/simple.min.css>Simple.css</option><option value=https://cdn.jsdelivr.net/gh/alvaromontoro/almond.css@latest/dist/almond.min.css>Almond.css</option><option value=https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css>New.css</option><option value=https://unpkg.com/missing.css>Missing.css</option><option value=https://unpkg.com/boltcss/bolt.min.css>Bolt.css</option><option value=https://perfectmotherfuckingwebsite.com/fuckingstyle.css>PerfectMFWS</option><option value>HTML only</option></select></div><script>(function(){"use strict";const o=document.getElementById("theme-style"),e=document.getElementById("theme-selector-input"),n="hugo-classless-theme";function s(t){o.href=t,e&&(e.value=t)}const t=localStorage.getItem(n);if(t){const n=Array.from(e.options).some(e=>e.value===t);n&&s(t)}e&&e.addEventListener("change",()=>{const t=e.value;s(t),localStorage.setItem(n,t)})})()</script><div><h3>mozanunal.com</h3><h4><a href=/>Home</a> | <a href=/posts/>Posts</a> | <a href=/projects/>Projects</a> | <a href=/papers/>Papers</a> | <a href=/contact/>Contact</a></h4></div></header><main><article><header><h1>Micropython Mqtt Streamer</h1><p><em><time datetime=2020-02-26>February 26, 2020</time></em></p></header><div><h1 id=micropython-mqtt-streamer>Micropython Mqtt Streamer</h1><p>Hello everyone, I have developed a micropython code to stream accelerometer data
over mqtt. Also I have created a tool to visualize the data which is transferred
from remote MQTT device which is executing micropython code.</p><h2 id=demo>Demo</h2><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/5v9RwN818p8?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=development>Development</h2><p>The first thing which I tried with micropython is connecting ESP8266 to a WiFi.
I have tried the following script which I found from the official documentation
of the micropython.</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81c8be>import</span> <span style=color:#ef9f76>network</span>
</span></span><span style=display:flex><span>wlan <span style=color:#99d1db;font-weight:700>=</span> network<span style=color:#99d1db;font-weight:700>.</span>WLAN(network<span style=color:#99d1db;font-weight:700>.</span>STA_IF)
</span></span><span style=display:flex><span>wlan<span style=color:#99d1db;font-weight:700>.</span>active(<span style=color:#ef9f76>True</span>)
</span></span><span style=display:flex><span>wlan<span style=color:#99d1db;font-weight:700>.</span>connect(<span style=color:#a6d189>&#39;ssid&#39;</span>, <span style=color:#a6d189>&#39;password&#39;</span>)
</span></span></code></pre></div><p>The wifi ip of the module can be examined with <code>wlan.ifconfig()</code> command. I
should say that scripting with a microcontoller is quite fun. ESP8266 was
connected over usb over Uart line to my computer and I can scripting using
micropython shell. For example: I have used upip module to install
<code>umqtt.simple</code> upython module to my ESP8266. After installing the umqtt module,
I have tested its basic examples and they worked without any problem.</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#99d1db;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#81c8be>import</span> <span style=color:#ef9f76>upip</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#99d1db>dir</span>(upip)
</span></span><span style=display:flex><span>[<span style=color:#a6d189>&#39;__class__&#39;</span>, <span style=color:#a6d189>&#39;__name__&#39;</span>, <span style=color:#a6d189>&#39;errno&#39;</span>, <span style=color:#a6d189>&#39;gc&#39;</span>, <span style=color:#a6d189>&#39;help&#39;</span>, <span style=color:#a6d189>&#39;json&#39;</span>, <span style=color:#a6d189>&#39;os&#39;</span>, <span style=color:#a6d189>&#39;sys&#39;</span>, <span style=color:#a6d189>&#39;usocket&#39;</span>, <span style=color:#a6d189>&#39;ussl&#39;</span>, <span style=color:#a6d189>&#39;uzlib&#39;</span>, <span style=color:#a6d189>&#39;main&#39;</span>, <span style=color:#a6d189>&#39;debug&#39;</span>, <span style=color:#a6d189>&#39;tarfile&#39;</span>, <span style=color:#a6d189>&#39;install_path&#39;</span>, <span style=color:#a6d189>&#39;cleanup_files&#39;</span>, <span style=color:#a6d189>&#39;gzdict_sz&#39;</span>, <span style=color:#a6d189>&#39;file_buf&#39;</span>, <span style=color:#a6d189>&#39;NotFoundError&#39;</span>, <span style=color:#a6d189>&#39;op_split&#39;</span>, <span style=color:#a6d189>&#39;op_basename&#39;</span>, <span style=color:#a6d189>&#39;_makedirs&#39;</span>, <span style=color:#a6d189>&#39;save_file&#39;</span>, <span style=color:#a6d189>&#39;install_tar&#39;</span>, <span style=color:#a6d189>&#39;expandhome&#39;</span>, <span style=color:#a6d189>&#39;warn_ussl&#39;</span>, <span style=color:#a6d189>&#39;url_open&#39;</span>, <span style=color:#a6d189>&#39;get_pkg_metadata&#39;</span>, <span style=color:#a6d189>&#39;fatal&#39;</span>, <span style=color:#a6d189>&#39;install_pkg&#39;</span>, <span style=color:#a6d189>&#39;install&#39;</span>, <span style=color:#a6d189>&#39;get_install_path&#39;</span>, <span style=color:#a6d189>&#39;cleanup&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>&gt;&gt;&gt;</span> upip<span style=color:#99d1db;font-weight:700>.</span>install(<span style=color:#a6d189>&#34;umqtt.simple&#34;</span>)
</span></span></code></pre></div><p>Next phase is reading data from accelerometer. I have used MPU6050 as the IMU
sensor. It consists a gyro and an accelerometer sensor. I have used i2c scanner
example code to detect the i2c address of the device. The address of my MPU6050
is <code>0x68</code>.</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#99d1db;font-weight:700>&gt;&gt;&gt;</span> i2c<span style=color:#99d1db;font-weight:700>.</span>scan() 
</span></span><span style=display:flex><span><span style=color:#737994;font-style:italic># scan for slaves on the bus, </span>
</span></span><span style=display:flex><span><span style=color:#737994;font-style:italic># returning a list of valid addresses</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#ca9ee6>for</span> device <span style=color:#99d1db;font-weight:700>in</span> devices:
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>...</span>     <span style=color:#99d1db>print</span>(<span style=color:#a6d189>&#34;Decimal address: &#34;</span>,device,<span style=color:#a6d189>&#34; | Hexa address: &#34;</span>,<span style=color:#99d1db>hex</span>(device))
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>...</span>
</span></span><span style=display:flex><span>Decimal address:  <span style=color:#ef9f76>104</span>  <span style=color:#99d1db;font-weight:700>|</span> Hexa address:  <span style=color:#ef9f76>0x68</span>
</span></span></code></pre></div><p>The following class is developed to read sensor values directly from MPU6050.</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81c8be>import</span> <span style=color:#ef9f76>machine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>class</span> <span style=color:#e5c890>accel</span>():
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>def</span> <span style=color:#8caaee>__init__</span>(<span style=color:#99d1db>self</span>, i2c, addr<span style=color:#99d1db;font-weight:700>=</span><span style=color:#ef9f76>0x68</span>):
</span></span><span style=display:flex><span>        <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>iic <span style=color:#99d1db;font-weight:700>=</span> i2c
</span></span><span style=display:flex><span>        <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>addr <span style=color:#99d1db;font-weight:700>=</span> addr
</span></span><span style=display:flex><span>        <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>iic<span style=color:#99d1db;font-weight:700>.</span>start()
</span></span><span style=display:flex><span>        <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>iic<span style=color:#99d1db;font-weight:700>.</span>writeto(<span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>addr, <span style=color:#99d1db>bytearray</span>([<span style=color:#ef9f76>107</span>, <span style=color:#ef9f76>0</span>]))
</span></span><span style=display:flex><span>        <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>iic<span style=color:#99d1db;font-weight:700>.</span>stop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>def</span> <span style=color:#8caaee>get_raw_values</span>(<span style=color:#99d1db>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>iic<span style=color:#99d1db;font-weight:700>.</span>start()
</span></span><span style=display:flex><span>        a <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>iic<span style=color:#99d1db;font-weight:700>.</span>readfrom_mem(<span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>addr, <span style=color:#ef9f76>0x3B</span>, <span style=color:#ef9f76>14</span>)
</span></span><span style=display:flex><span>        <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>iic<span style=color:#99d1db;font-weight:700>.</span>stop()
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>return</span> a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>def</span> <span style=color:#8caaee>get_ints</span>(<span style=color:#99d1db>self</span>):
</span></span><span style=display:flex><span>        b <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>get_raw_values()
</span></span><span style=display:flex><span>        c <span style=color:#99d1db;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>for</span> i <span style=color:#99d1db;font-weight:700>in</span> b:
</span></span><span style=display:flex><span>            c<span style=color:#99d1db;font-weight:700>.</span>append(i)
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>return</span> c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>def</span> <span style=color:#8caaee>bytes_toint</span>(<span style=color:#99d1db>self</span>, firstbyte, secondbyte):
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>if</span> <span style=color:#99d1db;font-weight:700>not</span> firstbyte <span style=color:#99d1db;font-weight:700>&amp;</span> <span style=color:#ef9f76>0x80</span>:
</span></span><span style=display:flex><span>            <span style=color:#ca9ee6>return</span> firstbyte <span style=color:#99d1db;font-weight:700>&lt;&lt;</span> <span style=color:#ef9f76>8</span> <span style=color:#99d1db;font-weight:700>|</span> secondbyte
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>return</span> <span style=color:#99d1db;font-weight:700>-</span> (((firstbyte <span style=color:#99d1db;font-weight:700>^</span> <span style=color:#ef9f76>255</span>) <span style=color:#99d1db;font-weight:700>&lt;&lt;</span> <span style=color:#ef9f76>8</span>) <span style=color:#99d1db;font-weight:700>|</span> (secondbyte <span style=color:#99d1db;font-weight:700>^</span> <span style=color:#ef9f76>255</span>) <span style=color:#99d1db;font-weight:700>+</span> <span style=color:#ef9f76>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>def</span> <span style=color:#8caaee>get_values</span>(<span style=color:#99d1db>self</span>):
</span></span><span style=display:flex><span>        raw_ints <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>get_raw_values()
</span></span><span style=display:flex><span>        vals <span style=color:#99d1db;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>        vals[<span style=color:#a6d189>&#34;AcX&#34;</span>] <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>bytes_toint(raw_ints[<span style=color:#ef9f76>0</span>], raw_ints[<span style=color:#ef9f76>1</span>])
</span></span><span style=display:flex><span>        vals[<span style=color:#a6d189>&#34;AcY&#34;</span>] <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>bytes_toint(raw_ints[<span style=color:#ef9f76>2</span>], raw_ints[<span style=color:#ef9f76>3</span>])
</span></span><span style=display:flex><span>        vals[<span style=color:#a6d189>&#34;AcZ&#34;</span>] <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>bytes_toint(raw_ints[<span style=color:#ef9f76>4</span>], raw_ints[<span style=color:#ef9f76>5</span>])
</span></span><span style=display:flex><span>        vals[<span style=color:#a6d189>&#34;Tmp&#34;</span>] <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>bytes_toint(raw_ints[<span style=color:#ef9f76>6</span>], raw_ints[<span style=color:#ef9f76>7</span>]) <span style=color:#99d1db;font-weight:700>/</span> <span style=color:#ef9f76>340.00</span> <span style=color:#99d1db;font-weight:700>+</span> <span style=color:#ef9f76>36.53</span>
</span></span><span style=display:flex><span>        vals[<span style=color:#a6d189>&#34;GyX&#34;</span>] <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>bytes_toint(raw_ints[<span style=color:#ef9f76>8</span>], raw_ints[<span style=color:#ef9f76>9</span>])
</span></span><span style=display:flex><span>        vals[<span style=color:#a6d189>&#34;GyY&#34;</span>] <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>bytes_toint(raw_ints[<span style=color:#ef9f76>10</span>], raw_ints[<span style=color:#ef9f76>11</span>])
</span></span><span style=display:flex><span>        vals[<span style=color:#a6d189>&#34;GyZ&#34;</span>] <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>bytes_toint(raw_ints[<span style=color:#ef9f76>12</span>], raw_ints[<span style=color:#ef9f76>13</span>])
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>return</span> vals  <span style=color:#737994;font-style:italic># returned in range of Int16</span>
</span></span><span style=display:flex><span>        <span style=color:#737994;font-style:italic># -32768 to 32767</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>def</span> <span style=color:#8caaee>val_test</span>(<span style=color:#99d1db>self</span>):  <span style=color:#737994;font-style:italic># ONLY FOR TESTING! Also, fast reading sometimes crashes IIC</span>
</span></span><span style=display:flex><span>        <span style=color:#81c8be>from</span> <span style=color:#ef9f76>time</span> <span style=color:#81c8be>import</span> sleep
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>while</span> <span style=color:#ef9f76>1</span>:
</span></span><span style=display:flex><span>            <span style=color:#99d1db>print</span>(<span style=color:#99d1db>self</span><span style=color:#99d1db;font-weight:700>.</span>get_values())
</span></span><span style=display:flex><span>            sleep(<span style=color:#ef9f76>0.05</span>)
</span></span></code></pre></div><p>Main loop is also quite strait-forward. It read samples from acc and send these
over mqtt protocol directly to the server.</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81c8be>from</span> <span style=color:#ef9f76>machine</span> <span style=color:#81c8be>import</span> I2C, Pin
</span></span><span style=display:flex><span><span style=color:#81c8be>import</span> <span style=color:#ef9f76>mpu6050</span>
</span></span><span style=display:flex><span><span style=color:#81c8be>from</span> <span style=color:#ef9f76>umqtt.simple</span> <span style=color:#81c8be>import</span> MQTTClient
</span></span><span style=display:flex><span><span style=color:#81c8be>import</span> <span style=color:#ef9f76>time</span><span style=color:#99d1db;font-weight:700>,</span> <span style=color:#ef9f76>json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>i2c <span style=color:#99d1db;font-weight:700>=</span> I2C(scl<span style=color:#99d1db;font-weight:700>=</span>Pin(<span style=color:#ef9f76>5</span>), sda<span style=color:#99d1db;font-weight:700>=</span>Pin(<span style=color:#ef9f76>4</span>))
</span></span><span style=display:flex><span>accelerometer <span style=color:#99d1db;font-weight:700>=</span> mpu6050<span style=color:#99d1db;font-weight:700>.</span>accel(i2c)
</span></span><span style=display:flex><span>c <span style=color:#99d1db;font-weight:700>=</span> MQTTClient(<span style=color:#a6d189>&#34;umqtt_client&#34;</span>, <span style=color:#a6d189>&#34;iot.eclipse.org&#34;</span>)
</span></span><span style=display:flex><span>c<span style=color:#99d1db;font-weight:700>.</span>connect()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>def</span> <span style=color:#8caaee>run</span>():
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>while</span> <span style=color:#ef9f76>True</span>:
</span></span><span style=display:flex><span>        c<span style=color:#99d1db;font-weight:700>.</span>publish( <span style=color:#e78284>b</span><span style=color:#a6d189>&#34;micropython/test/mpu6050&#34;</span>, json<span style=color:#99d1db;font-weight:700>.</span>dumps(accelerometer<span style=color:#99d1db;font-weight:700>.</span>get_values()) )
</span></span><span style=display:flex><span>        time<span style=color:#99d1db;font-weight:700>.</span>sleep_ms(<span style=color:#ef9f76>45</span>)
</span></span><span style=display:flex><span>run()
</span></span></code></pre></div><p><a href=https://github.com/mozanunal/micropython-mpu6050-mqtt-streamer>The code can be reached from this github repo.</a></p><h2 id=references>References</h2><ul><li><a href=https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/>https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/</a></li><li><a href=https://github.com/adamjezek98/MPU6050-ESP8266-MicroPython>https://github.com/adamjezek98/MPU6050-ESP8266-MicroPython</a> mpu6050.py</li><li><a href=https://docs.micropython.org/en/latest/library/network.WLAN.html>https://docs.micropython.org/en/latest/library/network.WLAN.html</a></li><li><a href=https://learn.adafruit.com/micropython-basics-esp8266-webrepl/access-webrepl>https://learn.adafruit.com/micropython-basics-esp8266-webrepl/access-webrepl</a></li></ul></div></article></main><footer><p>&copy; 2025 M.Ozan Unal.</p></footer></body><script async src="https://www.googletagmanager.com/gtag/js?id=G-007KSW65JL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-007KSW65JL")}</script></html>