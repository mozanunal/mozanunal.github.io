<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=description content="An example site for the clean and configurable Hugo Classless theme."><link href=/2020/02/micropython-mqtt-stream/ rel=alternate type=application/rss+xml title=mozanunal.com><link id=theme-style rel=stylesheet href=https://cdn.jsdelivr.net/gh/cspablocortez/cosmocss@latest/cosmo.min.css><style>pre code,code{-webkit-text-size-adjust:100%;text-size-adjust:100%}pre code.hljs{all:revert;display:block;font:.9rem/1.9 ui-monospace,SFMono-Regular,Menlo,monospace;overflow-x:auto}</style><title>Micropython Mqtt Streamer | mozanunal.com</title><link rel=icon href=/favicon.svg type=image/svg+xml><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon href=/apple-touch-icon.png></head><body><header><div class=theme-selector><select id=theme-selector-input><option value=https://cdn.jsdelivr.net/gh/cspablocortez/cosmocss@latest/cosmo.min.css>Cosmo.css</option><option value=https://cdn.jsdelivr.net/gh/digitallytailored/classless@latest/classless.min.css>Classless.css</option><option value=https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css>Pico</option><option value=https://cdn.jsdelivr.net/npm/water.css@2/out/water.css>Water.css</option><option value=https://cdn.simplecss.org/simple.min.css>Simple.css</option><option value=https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css>New.css</option><option value=https://unpkg.com/missing.css>Missing.css</option><option value=https://unpkg.com/boltcss/bolt.min.css>Bolt.css</option></select></div><script>(function(){"use strict";const o=document.getElementById("theme-style"),e=document.getElementById("theme-selector-input"),n="hugo-classless-theme";function s(t){o.href=t,e&&(e.value=t)}const t=localStorage.getItem(n);if(t){const n=Array.from(e.options).some(e=>e.value===t);n&&s(t)}e&&e.addEventListener("change",()=>{const t=e.value;s(t),localStorage.setItem(n,t)})})()</script><div><h1>mozanunal.com</h1><nav><p><a href=/>Home</a> | <a href=/posts/>Posts</a> | <a href=/projects/>Projects</a> | <a href=/papers/>Papers</a> | <a href=/contact/>Contact</a></p></nav></div></header><main><article><header><h1>Micropython Mqtt Streamer</h1><p><em><time datetime=2020-02-26>February 26, 2020</time></em></p></header><div><h1 id=micropython-mqtt-streamer>Micropython Mqtt Streamer</h1><p>Hello everyone, I have developed a micropython code to stream accelerometer data
over mqtt. Also I have created a tool to visualize the data which is transferred
from remote MQTT device which is executing micropython code.</p><h2 id=demo>Demo</h2><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/5v9RwN818p8?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=development>Development</h2><p>The first thing which I tried with micropython is connecting ESP8266 to a WiFi.
I have tried the following script which I found from the official documentation
of the micropython.</p><pre><code class=language-python>import network
wlan = network.WLAN(network.STA_IF)
wlan.active(True)
wlan.connect('ssid', 'password')
</code></pre><p>The wifi ip of the module can be examined with <code>wlan.ifconfig()</code> command. I
should say that scripting with a microcontoller is quite fun. ESP8266 was
connected over usb over Uart line to my computer and I can scripting using
micropython shell. For example: I have used upip module to install
<code>umqtt.simple</code> upython module to my ESP8266. After installing the umqtt module,
I have tested its basic examples and they worked without any problem.</p><pre><code class=language-python>&gt;&gt;&gt; import upip
&gt;&gt;&gt; dir(upip)
['__class__', '__name__', 'errno', 'gc', 'help', 'json', 'os', 'sys', 'usocket', 'ussl', 'uzlib', 'main', 'debug', 'tarfile', 'install_path', 'cleanup_files', 'gzdict_sz', 'file_buf', 'NotFoundError', 'op_split', 'op_basename', '_makedirs', 'save_file', 'install_tar', 'expandhome', 'warn_ussl', 'url_open', 'get_pkg_metadata', 'fatal', 'install_pkg', 'install', 'get_install_path', 'cleanup']
&gt;&gt;&gt; upip.install(&quot;umqtt.simple&quot;)
</code></pre><p>Next phase is reading data from accelerometer. I have used MPU6050 as the IMU
sensor. It consists a gyro and an accelerometer sensor. I have used i2c scanner
example code to detect the i2c address of the device. The address of my MPU6050
is <code>0x68</code>.</p><pre><code class=language-python>&gt;&gt;&gt; i2c.scan() 
# scan for slaves on the bus, 
# returning a list of valid addresses
&gt;&gt;&gt; for device in devices:
...     print(&quot;Decimal address: &quot;,device,&quot; | Hexa address: &quot;,hex(device))
...
...
...
Decimal address:  104  | Hexa address:  0x68
</code></pre><p>The following class is developed to read sensor values directly from MPU6050.</p><pre><code class=language-python>import machine


class accel():
    def __init__(self, i2c, addr=0x68):
        self.iic = i2c
        self.addr = addr
        self.iic.start()
        self.iic.writeto(self.addr, bytearray([107, 0]))
        self.iic.stop()

    def get_raw_values(self):
        self.iic.start()
        a = self.iic.readfrom_mem(self.addr, 0x3B, 14)
        self.iic.stop()
        return a

    def get_ints(self):
        b = self.get_raw_values()
        c = []
        for i in b:
            c.append(i)
        return c

    def bytes_toint(self, firstbyte, secondbyte):
        if not firstbyte &amp; 0x80:
            return firstbyte &lt;&lt; 8 | secondbyte
        return - (((firstbyte ^ 255) &lt;&lt; 8) | (secondbyte ^ 255) + 1)

    def get_values(self):
        raw_ints = self.get_raw_values()
        vals = {}
        vals[&quot;AcX&quot;] = self.bytes_toint(raw_ints[0], raw_ints[1])
        vals[&quot;AcY&quot;] = self.bytes_toint(raw_ints[2], raw_ints[3])
        vals[&quot;AcZ&quot;] = self.bytes_toint(raw_ints[4], raw_ints[5])
        vals[&quot;Tmp&quot;] = self.bytes_toint(raw_ints[6], raw_ints[7]) / 340.00 + 36.53
        vals[&quot;GyX&quot;] = self.bytes_toint(raw_ints[8], raw_ints[9])
        vals[&quot;GyY&quot;] = self.bytes_toint(raw_ints[10], raw_ints[11])
        vals[&quot;GyZ&quot;] = self.bytes_toint(raw_ints[12], raw_ints[13])
        return vals  # returned in range of Int16
        # -32768 to 32767

    def val_test(self):  # ONLY FOR TESTING! Also, fast reading sometimes crashes IIC
        from time import sleep
        while 1:
            print(self.get_values())
            sleep(0.05)
</code></pre><p>Main loop is also quite strait-forward. It read samples from acc and send these
over mqtt protocol directly to the server.</p><pre><code class=language-python>from machine import I2C, Pin
import mpu6050
from umqtt.simple import MQTTClient
import time, json

i2c = I2C(scl=Pin(5), sda=Pin(4))
accelerometer = mpu6050.accel(i2c)
c = MQTTClient(&quot;umqtt_client&quot;, &quot;iot.eclipse.org&quot;)
c.connect()

def run():
    while True:
        c.publish( b&quot;micropython/test/mpu6050&quot;, json.dumps(accelerometer.get_values()) )
        time.sleep_ms(45)
run()
</code></pre><p><a href=https://github.com/mozanunal/micropython-mpu6050-mqtt-streamer>The code can be reached from this github repo.</a></p><h2 id=references>References</h2><ul><li><a href=https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/>https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/</a></li><li><a href=https://github.com/adamjezek98/MPU6050-ESP8266-MicroPython>https://github.com/adamjezek98/MPU6050-ESP8266-MicroPython</a> mpu6050.py</li><li><a href=https://docs.micropython.org/en/latest/library/network.WLAN.html>https://docs.micropython.org/en/latest/library/network.WLAN.html</a></li><li><a href=https://learn.adafruit.com/micropython-basics-esp8266-webrepl/access-webrepl>https://learn.adafruit.com/micropython-basics-esp8266-webrepl/access-webrepl</a></li></ul></div></article></main><footer><p>&copy; 2025 M.Ozan Unal.</p></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/highlight.js@11.11.0/styles/github.min.css media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/highlight.js@11.11.0/styles/github-dark.min.css media="(prefers-color-scheme: dark)"><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js></script><script>hljs.highlightAll()</script></body><script async src="https://www.googletagmanager.com/gtag/js?id=G-007KSW65JL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-007KSW65JL")}</script></html>