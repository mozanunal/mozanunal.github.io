<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=description content="Personal website of M. Ozan Unal: posts, projects, and papers."><link rel=canonical href=https://mozanunal.com/2020/02/micropython-mqtt-stream/><link id=theme-style rel=stylesheet href=/css/classless.min.8cab153b82e5aafc291eef9470a782c75788db9fb12621ab48065a61682f0d2a.css integrity="sha256-jKsVO4LlqvwpHu+UcKeCx1eI25+xJiGrSAZaYWgvDSo="><link id=theme-style-dark rel=stylesheet href=/css/classless-dark.min.dfcff79e61518a7cd7fadd9ff9d784690eb5c3fc94e6d93e636ba054ec8e0ff1.css integrity="sha256-38/3nmFRinzX+t2f+deEaQ61w/yU5tk+Y2ugVOyOD/E=" media="(prefers-color-scheme: dark)"><style>#skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}#skip-link:focus{position:static;width:auto;height:auto;overflow:visible;padding:.5rem}pre code,code{-webkit-text-size-adjust:100%;text-size-adjust:100%}img{display:block;margin-left:auto;margin-right:auto}figcaption{display:block;margin-left:auto;margin-right:auto}header nav{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;overflow:visible;padding:.5rem 0;margin-bottom:1rem;font-size:1.25rem}header nav ul{display:flex;list-style:none;padding:0;margin:0;gap:0;align-items:center}header nav ul li+li::before{content:"|";padding:0 .4rem;opacity:.4}header nav a.active{font-weight:700;text-decoration:underline;text-underline-offset:.2em}@media(max-width:600px){header nav{flex-direction:column;align-items:flex-start;gap:.5rem}}.dark-mode-toggle{background:0 0;border:none;cursor:pointer;padding:.25rem;margin:0;min-height:auto;min-width:auto;display:inline-flex;align-items:center;justify-content:center;color:var(--body-color);border-radius:var(--border-radius);transition:var(--transition-base);box-shadow:none;line-height:1}.dark-mode-toggle:hover{opacity:.7;box-shadow:none}.dark-mode-toggle:active{transform:none;box-shadow:none;filter:none}.dark-mode-toggle:hover::after{background-color:initial}.dark-mode-toggle svg{width:1.25rem;height:1.25rem;fill:currentColor}.dark-mode-toggle .icon-sun{display:none}.dark-mode-toggle .icon-moon{display:none}.dark-mode-toggle .icon-system{display:block}html[data-theme=light] .dark-mode-toggle .icon-sun{display:block}html[data-theme=light] .dark-mode-toggle .icon-moon{display:none}html[data-theme=light] .dark-mode-toggle .icon-system{display:none}html[data-theme=dark] .dark-mode-toggle .icon-sun{display:none}html[data-theme=dark] .dark-mode-toggle .icon-moon{display:block}html[data-theme=dark] .dark-mode-toggle .icon-system{display:none}</style><link id=syntax-light rel=stylesheet href=/css/syntax-light.min.d1e9974bf1fe0f3bfae6a7af3a04c1e749276b8efbbf6d3397998585f82443f0.css media="(prefers-color-scheme: light)"><link id=syntax-dark rel=stylesheet href=/css/syntax-dark.min.22964c63865be9217cedda7ac3dbd0143f8f41b3a0f681ef71e845b18a33a4f3.css media="(prefers-color-scheme: dark)"><title>Micropython Mqtt Streamer | mozanunal.com</title><link rel=icon href=/favicon.svg type=image/svg+xml><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon href=/apple-touch-icon.png><meta property="og:title" content="Micropython Mqtt Streamer"><meta property="og:description" content="Personal website of M. Ozan Unal: posts, projects, and papers."><meta property="og:type" content="article"><meta property="og:url" content="https://mozanunal.com/2020/02/micropython-mqtt-stream/"><meta property="og:site_name" content="mozanunal.com"><meta property="article:published_time" content="2020-02-26T22:36:00Z"><meta property="article:modified_time" content="2020-02-26T22:36:00Z"><meta property="article:tag" content="MPU6050"><meta property="article:tag" content="Mqtt"><meta property="article:tag" content="IoT"><meta property="article:tag" content="Arduino"><meta name=twitter:card content="summary"><meta name=twitter:title content="Micropython Mqtt Streamer"><meta name=twitter:description content="Personal website of M. Ozan Unal: posts, projects, and papers."><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"M.Ozan Unal"},"dateModified":"2020-02-26T22:36:00Z","datePublished":"2020-02-26T22:36:00Z","description":"Micropython Mqtt Streamer Hello everyone, I have developed a micropython code to stream accelerometer data over mqtt. Also I have created a tool to visualize …","headline":"Micropython Mqtt Streamer"}</script></head><body><a id=skip-link href=#main-content>Skip to content</a><header><nav aria-label="Main navigation"><ul><li><strong>mozanunal.com</strong></li></ul><ul><li><a href=/>Home</a></li><li><a href=/posts/ class=active aria-current=page>Posts</a></li><li><a href=/projects/>Projects</a></li><li><a href=/papers/>Papers</a></li><li><button class=dark-mode-toggle id=dark-mode-toggle aria-label="Toggle color scheme" title="Toggle color scheme">
<svg class="icon-moon" viewBox="0 0 24 24" fill="currentColor"><path d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg>
<svg class="icon-sun" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75.0 01.75.75v2.25a.75.75.0 01-1.5.0V3a.75.75.0 01.75-.75zM7.5 12a4.5 4.5.0 119 0 4.5 4.5.0 01-9 0zM18.894 6.166a.75.75.0 00-1.06-1.06l-1.591 1.59a.75.75.0 101.06 1.061l1.591-1.59zM21.75 12a.75.75.0 01-.75.75h-2.25a.75.75.0 010-1.5H21a.75.75.0 01.75.75zm-3.916 6.894a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 10-1.061 1.06l1.59 1.591zM12 18a.75.75.0 01.75.75V21a.75.75.0 01-1.5.0v-2.25A.75.75.0 0112 18zM7.758 17.303a.75.75.0 00-1.061-1.06l-1.591 1.59a.75.75.0 001.06 1.061l1.591-1.59zM6 12a.75.75.0 01-.75.75H3a.75.75.0 010-1.5h2.25A.75.75.0 016 12zm.697-4.243a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 00-1.061 1.06l1.59 1.591z"/></svg>
<svg class="icon-system" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 5.25a3 3 0 013-3h13.5a3 3 0 013 3V15a3 3 0 01-3 3h-3v.75A.75.75.0 0115 19.5H9a.75.75.0 01-.75-.75V18h-3a3 3 0 01-3-3V5.25zm1.5.0a1.5 1.5.0 011.5-1.5h13.5a1.5 1.5.0 011.5 1.5V15a1.5 1.5.0 01-1.5 1.5H5.25A1.5 1.5.0 013.75 15V5.25z" clip-rule="evenodd"/></svg></button></li><script>(function(){var e,o,t="hugo-classless-color-scheme";function n(e,t,n,s){if(!e)return;t==="dark"?e.media=s:t==="light"?e.media=n:e.media=e.getAttribute("data-default-media")||""}function s(e){document.documentElement.setAttribute("data-theme",e);var t,s=document.getElementById("syntax-light"),o=document.getElementById("syntax-dark");n(s,e,"all","not all"),n(o,e,"not all","all"),t=document.getElementById("theme-style-dark"),n(t,e,"not all","all")}function i(){["syntax-light","syntax-dark","theme-style-dark"].forEach(function(e){var t=document.getElementById(e);t&&!t.getAttribute("data-default-media")&&t.setAttribute("data-default-media",t.media||"")})}e=null;try{e=localStorage.getItem(t)}catch{}o=e==="light"||e==="dark"?e:"system",document.documentElement.setAttribute("data-theme",o),document.addEventListener("DOMContentLoaded",function(){i(),s(o);var e=document.getElementById("dark-mode-toggle");if(!e)return;e.addEventListener("click",function(){var e,n=document.documentElement.getAttribute("data-theme");n==="light"?e="dark":n==="dark"?e="system":e="light",s(e);try{e==="system"?localStorage.removeItem(t):localStorage.setItem(t,e)}catch{}})}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){document.documentElement.getAttribute("data-theme")==="system"&&s("system")})})()</script></ul></nav></header><main id=main-content><article><p style=margin-bottom:0><a href=/>mozanunal.com</a>&nbsp;/&nbsp;<a href=https://mozanunal.com/posts/>Posts</a>&nbsp;/&nbsp;Micropython Mqtt Streamer</p><h1>Micropython Mqtt Streamer</h1><p><em><time datetime=2020-02-26>February 26, 2020</time>
&#183; 3 min read</em></p><details><summary>Table of Contents</summary><nav id=TableOfContents><ul><li><a href=#demo>Demo</a></li><li><a href=#development>Development</a></li><li><a href=#references>References</a></li></ul></nav></details><div><h1 id=micropython-mqtt-streamer>Micropython Mqtt Streamer</h1><p>Hello everyone, I have developed a micropython code to stream accelerometer data
over mqtt. Also I have created a tool to visualize the data which is transferred
from remote MQTT device which is executing micropython code.</p><h2 id=demo>Demo</h2><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/5v9RwN818p8?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=development>Development</h2><p>The first thing which I tried with micropython is connecting ESP8266 to a WiFi.
I have tried the following script which I found from the official documentation
of the micropython.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>network</span>
</span></span><span class=line><span class=cl><span class=n>wlan</span> <span class=o>=</span> <span class=n>network</span><span class=o>.</span><span class=n>WLAN</span><span class=p>(</span><span class=n>network</span><span class=o>.</span><span class=n>STA_IF</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>wlan</span><span class=o>.</span><span class=n>active</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>wlan</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;ssid&#39;</span><span class=p>,</span> <span class=s1>&#39;password&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>The wifi ip of the module can be examined with <code>wlan.ifconfig()</code> command. I
should say that scripting with a microcontoller is quite fun. ESP8266 was
connected over usb over Uart line to my computer and I can scripting using
micropython shell. For example: I have used upip module to install
<code>umqtt.simple</code> upython module to my ESP8266. After installing the umqtt module,
I have tested its basic examples and they worked without any problem.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>upip</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>dir</span><span class=p>(</span><span class=n>upip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;__class__&#39;</span><span class=p>,</span> <span class=s1>&#39;__name__&#39;</span><span class=p>,</span> <span class=s1>&#39;errno&#39;</span><span class=p>,</span> <span class=s1>&#39;gc&#39;</span><span class=p>,</span> <span class=s1>&#39;help&#39;</span><span class=p>,</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span> <span class=s1>&#39;os&#39;</span><span class=p>,</span> <span class=s1>&#39;sys&#39;</span><span class=p>,</span> <span class=s1>&#39;usocket&#39;</span><span class=p>,</span> <span class=s1>&#39;ussl&#39;</span><span class=p>,</span> <span class=s1>&#39;uzlib&#39;</span><span class=p>,</span> <span class=s1>&#39;main&#39;</span><span class=p>,</span> <span class=s1>&#39;debug&#39;</span><span class=p>,</span> <span class=s1>&#39;tarfile&#39;</span><span class=p>,</span> <span class=s1>&#39;install_path&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanup_files&#39;</span><span class=p>,</span> <span class=s1>&#39;gzdict_sz&#39;</span><span class=p>,</span> <span class=s1>&#39;file_buf&#39;</span><span class=p>,</span> <span class=s1>&#39;NotFoundError&#39;</span><span class=p>,</span> <span class=s1>&#39;op_split&#39;</span><span class=p>,</span> <span class=s1>&#39;op_basename&#39;</span><span class=p>,</span> <span class=s1>&#39;_makedirs&#39;</span><span class=p>,</span> <span class=s1>&#39;save_file&#39;</span><span class=p>,</span> <span class=s1>&#39;install_tar&#39;</span><span class=p>,</span> <span class=s1>&#39;expandhome&#39;</span><span class=p>,</span> <span class=s1>&#39;warn_ussl&#39;</span><span class=p>,</span> <span class=s1>&#39;url_open&#39;</span><span class=p>,</span> <span class=s1>&#39;get_pkg_metadata&#39;</span><span class=p>,</span> <span class=s1>&#39;fatal&#39;</span><span class=p>,</span> <span class=s1>&#39;install_pkg&#39;</span><span class=p>,</span> <span class=s1>&#39;install&#39;</span><span class=p>,</span> <span class=s1>&#39;get_install_path&#39;</span><span class=p>,</span> <span class=s1>&#39;cleanup&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>upip</span><span class=o>.</span><span class=n>install</span><span class=p>(</span><span class=s2>&#34;umqtt.simple&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Next phase is reading data from accelerometer. I have used MPU6050 as the IMU
sensor. It consists a gyro and an accelerometer sensor. I have used i2c scanner
example code to detect the i2c address of the device. The address of my MPU6050
is <code>0x68</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>i2c</span><span class=o>.</span><span class=n>scan</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># scan for slaves on the bus,</span>
</span></span><span class=line><span class=cl><span class=c1># returning a list of valid addresses</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>device</span> <span class=ow>in</span> <span class=n>devices</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Decimal address: &#34;</span><span class=p>,</span><span class=n>device</span><span class=p>,</span><span class=s2>&#34; | Hexa address: &#34;</span><span class=p>,</span><span class=nb>hex</span><span class=p>(</span><span class=n>device</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>Decimal</span> <span class=n>address</span><span class=p>:</span>  <span class=mi>104</span>  <span class=o>|</span> <span class=n>Hexa</span> <span class=n>address</span><span class=p>:</span>  <span class=mh>0x68</span>
</span></span></code></pre></div><p>The following class is developed to read sensor values directly from MPU6050.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>machine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>accel</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>i2c</span><span class=p>,</span> <span class=n>addr</span><span class=o>=</span><span class=mh>0x68</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iic</span> <span class=o>=</span> <span class=n>i2c</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>addr</span> <span class=o>=</span> <span class=n>addr</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iic</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iic</span><span class=o>.</span><span class=n>writeto</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>,</span> <span class=nb>bytearray</span><span class=p>([</span><span class=mi>107</span><span class=p>,</span> <span class=mi>0</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iic</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_raw_values</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iic</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>iic</span><span class=o>.</span><span class=n>readfrom_mem</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>,</span> <span class=mh>0x3B</span><span class=p>,</span> <span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iic</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_ints</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_raw_values</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>b</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>c</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bytes_toint</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>firstbyte</span><span class=p>,</span> <span class=n>secondbyte</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>firstbyte</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>firstbyte</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span> <span class=o>|</span> <span class=n>secondbyte</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span> <span class=p>(((</span><span class=n>firstbyte</span> <span class=o>^</span> <span class=mi>255</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>secondbyte</span> <span class=o>^</span> <span class=mi>255</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_values</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_ints</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_raw_values</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span><span class=p>[</span><span class=s2>&#34;AcX&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bytes_toint</span><span class=p>(</span><span class=n>raw_ints</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>raw_ints</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span><span class=p>[</span><span class=s2>&#34;AcY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bytes_toint</span><span class=p>(</span><span class=n>raw_ints</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>raw_ints</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span><span class=p>[</span><span class=s2>&#34;AcZ&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bytes_toint</span><span class=p>(</span><span class=n>raw_ints</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=n>raw_ints</span><span class=p>[</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span><span class=p>[</span><span class=s2>&#34;Tmp&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bytes_toint</span><span class=p>(</span><span class=n>raw_ints</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=n>raw_ints</span><span class=p>[</span><span class=mi>7</span><span class=p>])</span> <span class=o>/</span> <span class=mf>340.00</span> <span class=o>+</span> <span class=mf>36.53</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span><span class=p>[</span><span class=s2>&#34;GyX&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bytes_toint</span><span class=p>(</span><span class=n>raw_ints</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=n>raw_ints</span><span class=p>[</span><span class=mi>9</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span><span class=p>[</span><span class=s2>&#34;GyY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bytes_toint</span><span class=p>(</span><span class=n>raw_ints</span><span class=p>[</span><span class=mi>10</span><span class=p>],</span> <span class=n>raw_ints</span><span class=p>[</span><span class=mi>11</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>vals</span><span class=p>[</span><span class=s2>&#34;GyZ&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bytes_toint</span><span class=p>(</span><span class=n>raw_ints</span><span class=p>[</span><span class=mi>12</span><span class=p>],</span> <span class=n>raw_ints</span><span class=p>[</span><span class=mi>13</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>vals</span>  <span class=c1># returned in range of Int16</span>
</span></span><span class=line><span class=cl>        <span class=c1># -32768 to 32767</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>val_test</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>  <span class=c1># ONLY FOR TESTING! Also, fast reading sometimes crashes IIC</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span></code></pre></div><p>Main loop is also quite strait-forward. It read samples from acc and send these
over mqtt protocol directly to the server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>machine</span> <span class=kn>import</span> <span class=n>I2C</span><span class=p>,</span> <span class=n>Pin</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mpu6050</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>umqtt.simple</span> <span class=kn>import</span> <span class=n>MQTTClient</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>i2c</span> <span class=o>=</span> <span class=n>I2C</span><span class=p>(</span><span class=n>scl</span><span class=o>=</span><span class=n>Pin</span><span class=p>(</span><span class=mi>5</span><span class=p>),</span> <span class=n>sda</span><span class=o>=</span><span class=n>Pin</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>accelerometer</span> <span class=o>=</span> <span class=n>mpu6050</span><span class=o>.</span><span class=n>accel</span><span class=p>(</span><span class=n>i2c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=n>MQTTClient</span><span class=p>(</span><span class=s2>&#34;umqtt_client&#34;</span><span class=p>,</span> <span class=s2>&#34;iot.eclipse.org&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span> <span class=sa>b</span><span class=s2>&#34;micropython/test/mpu6050&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>accelerometer</span><span class=o>.</span><span class=n>get_values</span><span class=p>())</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep_ms</span><span class=p>(</span><span class=mi>45</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></div><p><a href=https://github.com/mozanunal/micropython-mpu6050-mqtt-streamer>The code can be reached from this github repo.</a></p><h2 id=references>References</h2><ul><li><a href=https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/>https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/</a></li><li><a href=https://github.com/adamjezek98/MPU6050-ESP8266-MicroPython>https://github.com/adamjezek98/MPU6050-ESP8266-MicroPython</a> mpu6050.py</li><li><a href=https://docs.micropython.org/en/latest/library/network.WLAN.html>https://docs.micropython.org/en/latest/library/network.WLAN.html</a></li><li><a href=https://learn.adafruit.com/micropython-basics-esp8266-webrepl/access-webrepl>https://learn.adafruit.com/micropython-basics-esp8266-webrepl/access-webrepl</a></li></ul></div><hr><p><strong>Tags:</strong><a href=https://mozanunal.com/tags/mpu6050/>MPU6050</a>, <a href=https://mozanunal.com/tags/mqtt/>Mqtt</a>, <a href=https://mozanunal.com/tags/iot/>IoT</a>, <a href=https://mozanunal.com/tags/arduino/>Arduino</a></p><hr><h3>Related Posts</h3><ul><li><a href=https://mozanunal.com/2017/06/internet-of-beaches/>Internet of Beach</a></li><li><a href=https://mozanunal.com/2015/01/robot-kol/>[TR] Robot Kol</a></li><li><a href=https://mozanunal.com/2015/01/lcd-gostergeli-mesafe-olcer/>[TR] LCD Göstergeli Mesafe Ölçer</a></li><li><a href=https://mozanunal.com/2014/11/imu-aclarnn-3-boyutlu-olarak/>[TR] IMU Açılarının 3 Boyutlu Olarak Görsellenmesi</a></li><li><a href=https://mozanunal.com/2014/10/arduino-joystick-kontrol/>[TR] Arduino Joystick Kontrol</a></li></ul><hr><p><a href=https://mozanunal.com/2019/11/ecg-signal/>&larr; Digital Filtering of an ECG Signal</a> | <a href=https://mozanunal.com/2020/03/coolest-c-trick/>Coolest C Trick &rarr;</a></p></article></main><footer><p>&copy; 2026 M.Ozan Unal.</p></footer></body><link rel=stylesheet href=/libs/katex/katex.min.v0.16.9.css><script defer src=/libs/katex/katex.min.v0.16.9.js></script><script defer src=/libs/katex/auto-render.v0.16.9.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-007KSW65JL"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-007KSW65JL")}</script></html>